<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè† Chore Champions!</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bubblegum+Sans&family=Fredoka:wght@400;600&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Fredoka', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
            min-height: 100vh;
            padding: 15px;
            overflow-x: hidden;
        }

        @keyframes gradient {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Floating bubbles background */
        .bubble {
            position: fixed;
            bottom: -100px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            animation: rise 15s infinite ease-in;
            z-index: 0;
        }

        @keyframes rise {
            to {
                bottom: 110vh;
                transform: translateX(100px) rotate(360deg);
            }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 25px;
            align-items: start;
        }

        /* ========= PLAYER SELECTION ========= */
        .player-selection {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 85vh;
            text-align: center;
        }

        .player-selection h1 {
            font-family: 'Bubblegum Sans', cursive;
            color: #fff;
            font-size: 4em;
            margin-bottom: 10px;
            text-shadow: 4px 4px 0px rgba(0, 0, 0, 0.2);
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        .player-selection p {
            color: #fff;
            font-size: 1.5em;
            margin-bottom: 40px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .player-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 25px;
            width: 100%;
            max-width: 700px;
        }

        .player-card {
            background: white;
            padding: 30px 20px;
            border-radius: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .player-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transform: rotate(45deg);
            transition: 0.5s;
        }

        .player-card:hover::before {
            left: 100%;
        }

        .player-card:hover {
            transform: translateY(-15px) scale(1.08) rotate(-2deg);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
        }

        .player-avatar {
            font-size: 5em;
            margin-bottom: 15px;
            display: block;
            animation: wiggle 3s infinite;
        }

        @keyframes wiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-10deg); }
            75% { transform: rotate(10deg); }
        }

        .player-card h2 {
            font-family: 'Bubblegum Sans', cursive;
            font-size: 1.8em;
            margin-bottom: 8px;
            color: #333;
        }

        .player-card .role {
            font-size: 0.9em;
            color: #666;
            font-weight: 600;
        }

        /* ========= MAIN APP ========= */
        .app-container {
            display: none;
        }

        .header {
            background: white;
            padding: 25px;
            border-radius: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .current-player {
            display: flex;
            align-items: center;
            gap: 12px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 12px 20px;
            border-radius: 50px;
            color: white;
            font-size: 1.2em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .current-player:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .current-player-avatar {
            font-size: 2em;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 50px;
            font-family: 'Fredoka', sans-serif;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .btn:active {
            transform: translateY(-1px);
        }

        .btn-primary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            color: white;
        }

        /* ========= LEADERBOARD ========= */
        .leaderboard {
            background: white;
            padding: 25px;
            border-radius: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            margin-bottom: 25px;
        }

        .leaderboard h2 {
            font-family: 'Bubblegum Sans', cursive;
            font-size: 2.5em;
            margin-bottom: 20px;
            color: #333;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .leaderboard-grid {
            display: grid;
            gap: 15px;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            border-radius: 25px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .leaderboard-item:hover {
            transform: translateX(10px) scale(1.02);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .leaderboard-item.rank-1 {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            transform: scale(1.05);
        }

        .leaderboard-item.rank-2 {
            background: linear-gradient(135deg, #C0C0C0 0%, #808080 100%);
        }

        .leaderboard-item.rank-3 {
            background: linear-gradient(135deg, #CD7F32 0%, #8B4513 100%);
        }

        .leaderboard-rank {
            font-size: 2em;
            font-weight: bold;
            width: 50px;
            text-align: center;
        }

        .leaderboard-avatar {
            font-size: 3em;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .leaderboard-info {
            flex: 1;
        }

        .leaderboard-name {
            font-size: 1.5em;
            font-weight: 600;
            color: #333;
        }

        .leaderboard-points {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ========= CHORES ========= */
        .chores-section {
            background: white;
            padding: 25px;
            border-radius: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        .chores-section h2 {
            font-family: 'Bubblegum Sans', cursive;
            font-size: 2.5em;
            margin-bottom: 20px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chore-card {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            padding: 25px;
            border-radius: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .chore-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: 0.5s;
        }

        .chore-card:hover::before {
            left: 100%;
        }

        .chore-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .chore-card.completed {
            opacity: 0.7;
            background: linear-gradient(135deg, #c3cfe2 0%, #c3cfe2 100%);
        }

        .chore-card.priority-high {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .chore-card.priority-medium {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        }

        .chore-card.priority-low {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        }

        .chore-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
            gap: 15px;
        }

        .chore-title {
            font-size: 1.8em;
            font-weight: 600;
            color: #333;
            flex: 1;
        }

        .chore-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .chore-description {
            color: #555;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .chore-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 18px;
            background: white;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .checkbox-wrapper:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }

        .checkbox-wrapper input[type="checkbox"] {
            width: 25px;
            height: 25px;
            cursor: pointer;
        }

        /* ========= MODAL ========= */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 40px;
            border-radius: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.3s;
            position: relative;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-content h2 {
            font-family: 'Bubblegum Sans', cursive;
            font-size: 2.5em;
            margin-bottom: 25px;
            color: #333;
            text-align: center;
        }

        .close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 2em;
            font-weight: bold;
            color: #999;
            cursor: pointer;
            transition: all 0.3s;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close:hover {
            background: #f0f0f0;
            color: #333;
            transform: rotate(90deg);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #333;
            font-size: 1.1em;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 15px;
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            font-family: 'Fredoka', sans-serif;
            font-size: 1em;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Avatar Picker */
        .avatar-picker {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .avatar-option {
            font-size: 3em;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            border-radius: 20px;
            transition: all 0.3s;
            background: #f5f5f5;
            border: 3px solid transparent;
        }

        .avatar-option:hover {
            transform: scale(1.15);
            background: #e0e0e0;
        }

        .avatar-option.selected {
            border-color: #667eea;
            background: #e8eaff;
            transform: scale(1.1);
        }

        /* Color Picker */
        .color-picker {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 12px;
            margin-top: 15px;
        }

        .color-option {
            width: 100%;
            height: 60px;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .color-option:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .color-option.selected {
            border-color: #333;
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        /* Confetti */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #f0f;
            position: fixed;
            animation: confetti-fall 3s linear;
            z-index: 9999;
        }

        @keyframes confetti-fall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 600px) {
            .player-selection h1 {
                font-size: 2.5em;
            }

            .player-card {
                padding: 25px 15px;
            }

            .player-avatar {
                font-size: 3.5em;
            }

            .header {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            .chore-title {
                font-size: 1.4em;
            }

            .leaderboard h2,
            .chores-section h2 {
                font-size: 2em;
            }
        }

        .hidden {
            display: none;
        }

        /* Assignment specific styles */
        #userAssignments {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 15px;
            margin-top: 15px;
        }

        .assignment-checkbox {
            width: auto !important;
            margin-right: 10px;
        }

        .completed-by {
            font-size: 0.9em;
            color: #666;
            margin-top: 8px;
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 15px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <!-- Animated Background Bubbles -->
    <div class="bubble" style="width: 80px; height: 80px; left: 10%; animation-delay: 0s;"></div>
    <div class="bubble" style="width: 40px; height: 40px; left: 30%; animation-delay: 2s;"></div>
    <div class="bubble" style="width: 60px; height: 60px; left: 50%; animation-delay: 4s;"></div>
    <div class="bubble" style="width: 90px; height: 90px; left: 70%; animation-delay: 1s;"></div>
    <div class="bubble" style="width: 50px; height: 50px; left: 85%; animation-delay: 3s;"></div>

    <div class="container">
        <!-- PLAYER SELECTION SCREEN -->
        <div class="player-selection" id="playerSelection">
            <h1>üè† Chore Champions!</h1>
            <p>Who's ready to earn some points?</p>
            <div class="player-grid" id="playerGrid"></div>
        </div>

        <!-- MAIN APP -->
        <div class="app-container" id="appContainer">
            <!-- Header -->
            <div class="header">
                <div class="header-left">
                    <div class="current-player" id="currentPlayerDisplay" onclick="openProfileModal()">
                        <span class="current-player-avatar" id="currentPlayerAvatar">üë§</span>
                        <span id="currentPlayerName">Player</span>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" onclick="switchPlayer()">üîÑ Switch Player</button>
                    <button class="btn btn-primary hidden" id="addChoreBtn" onclick="openAddChoreModal()">‚ûï Add Chore</button>
                </div>
            </div>

            <!-- Main Grid Layout -->
            <div class="main-grid">
                <!-- Chores (Left Side) -->
                <div class="chores-section">
                    <h2>üìù Chores</h2>
                    <div id="choresList"></div>
                </div>

                <!-- Leaderboard (Right Side) -->
                <div class="leaderboard" style="position: sticky; top: 20px;">
                    <h2>üèÜ Leaderboard</h2>
                    <div class="leaderboard-grid" id="leaderboardGrid"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile Customization Modal -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeProfileModal()">&times;</span>
            <h2>‚ú® Customize Profile</h2>
            
            <div class="form-group">
                <label>Choose Your Avatar:</label>
                <div class="avatar-picker" id="avatarPicker"></div>
            </div>
            
            <div class="form-group">
                <label>Choose Your Color:</label>
                <div class="color-picker" id="colorPicker"></div>
            </div>
            
            <button class="btn btn-success" onclick="saveProfile()" style="width: 100%; font-size: 1.2em;">üíæ Save Profile</button>
        </div>
    </div>

    <!-- Add/Edit Chore Modal -->
    <div id="choreModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeChoreModal()">&times;</span>
            <h2 id="choreModalTitle">‚ûï Add New Chore</h2>
            <form id="choreForm">
                <div class="form-group">
                    <label for="title">Title *</label>
                    <input type="text" id="title" name="title" required placeholder="e.g., Make your bed">
                </div>
                
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" name="description" placeholder="Any extra details..."></textarea>
                </div>
                
                <div class="form-group">
                    <label for="priority">Priority</label>
                    <select id="priority" name="priority">
                        <option value="low">üü¢ Low (1 point)</option>
                        <option value="medium" selected>üü° Medium (1 point)</option>
                        <option value="high">üî¥ High (2 points)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="recurrenceType">Recurrence</label>
                    <select id="recurrenceType" name="recurrenceType">
                        <option value="daily">üåÖ Daily recurring (resets at midnight)</option>
                        <option value="weekly" selected>üìÖ Weekly recurring (resets Monday morning)</option>
                        <option value="one-time">‚≠ê One-time task (stays done)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="assignToAll" name="assignToAll" checked onchange="toggleAssignments()" style="width: auto; margin-right: 10px;">
                        <span>Everyone can complete (general chore)</span>
                    </label>
                    <div id="userAssignments" style="display: none;">
                        <p style="margin-bottom: 10px; font-weight: 600;">Assign to specific players:</p>
                        <div id="assignmentCheckboxes"></div>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-success" style="width: 100%; font-size: 1.2em;">üíæ Save Chore</button>
            </form>
        </div>
    </div>

    <!-- User History Modal -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeHistoryModal()">&times;</span>
            <h2 id="historyModalTitle">üéâ Completed Chores</h2>
            <div id="historyList"></div>
        </div>
    </div>

    <script>
        // Global variables
        let users = [];
        let currentUser = null;
        let chores = [];
        let editingChoreId = null;

        // Avatar and color options
        const avatars = ['üòÄ', 'üòé', 'ü§©', 'ü•≥', 'ü§ñ', 'üëæ', 'ü¶Ñ', 'üê∂', 'üê±', 'üêº', 'ü¶ä', 'üê∏', 'ü¶Å', 'üêØ', 'üê®', 'üêµ', 'ü¶â', 'ü¶ã', 'üåà', '‚≠ê', 'üé®', 'üéÆ', '‚öΩ', 'üèÄ'];
        const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2', '#F8B88B', '#FAD7A0', '#D7BDE2', '#A2D9CE', '#F5B7B1', '#AED6F1', '#A9DFBF', '#FAD7A0', '#D7DBDD', '#F9E79F', '#A3E4D7', '#D5A6BD'];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadUsers();
        });

        // Load users
        async function loadUsers() {
            try {
                const response = await fetch('/api/users');
                users = await response.json();
                renderPlayerSelection();
            } catch (error) {
                console.error('Error loading users:', error);
                alert('Failed to load users. Please refresh the page.');
            }
        }

        // Render player selection
        function renderPlayerSelection() {
            const grid = document.getElementById('playerGrid');
            grid.innerHTML = users.map(user => {
                const bgColor = user.color || '#6366f1';
                const avatar = user.avatar || 'üë§';
                return `
                    <div class="player-card" style="background: ${bgColor};" onclick="selectPlayer(${user.id})">
                        <span class="player-avatar">${avatar}</span>
                        <h2>${escapeHtml(user.name)}</h2>
                        <div class="role">${user.role === 'admin' ? '‚öôÔ∏è Admin' : '‚≠ê Player'}</div>
                    </div>
                `;
            }).join('');
        }

        // Select player
        function selectPlayer(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            // Check PIN for admin accounts
            if (user.role === 'admin' && user.pin) {
                const enteredPin = prompt(`üîí Enter PIN for ${user.name}:`);
                if (enteredPin !== user.pin) {
                    alert('‚ùå Incorrect PIN!');
                    return;
                }
            }

            currentUser = user;

            // Update UI
            document.getElementById('playerSelection').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            
            const avatar = currentUser.avatar || 'üë§';
            const color = currentUser.color || '#6366f1';
            
            document.getElementById('currentPlayerAvatar').textContent = avatar;
            document.getElementById('currentPlayerName').textContent = currentUser.name;
            document.getElementById('currentPlayerDisplay').style.background = color;

            // Show/hide admin controls
            if (currentUser.role === 'admin') {
                document.getElementById('addChoreBtn').classList.remove('hidden');
            } else {
                document.getElementById('addChoreBtn').classList.add('hidden');
            }

            // Load data
            loadChores();
            loadLeaderboard();
        }

        // Switch player
        function switchPlayer() {
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('playerSelection').style.display = 'flex';
            currentUser = null;
        }

        // Load chores
        async function loadChores() {
            if (!currentUser) return;
            
            try {
                const isAdmin = currentUser.role === 'admin';
                const response = await fetch(`/api/chores?user_id=${currentUser.id}&is_admin=${isAdmin}`);
                chores = await response.json();
                renderChores();
            } catch (error) {
                console.error('Error loading chores:', error);
                alert('Failed to load chores.');
            }
        }

        // Render chores
        function renderChores() {
            const list = document.getElementById('choresList');
            
            if (chores.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #999; font-size: 1.2em; padding: 40px;">No chores yet! üéâ</p>';
                return;
            }

            list.innerHTML = chores.map(chore => {
                const isCompleted = chore.completed;
                const isAdmin = currentUser.role === 'admin';
                const completedClass = isCompleted ? 'completed' : '';
                const priorityClass = `priority-${chore.priority}`;
                
                // Recurrence badge
                let recurrenceBadge = '';
                if (chore.recurrence_type === 'daily') {
                    recurrenceBadge = '<span class="badge">üåÖ Daily</span>';
                } else if (chore.recurrence_type === 'weekly') {
                    recurrenceBadge = '<span class="badge">üìÖ Weekly</span>';
                } else {
                    recurrenceBadge = '<span class="badge">‚≠ê One-time</span>';
                }

                // Points badge
                const points = chore.points || 1;
                const pointsBadge = `<span class="badge">‚≠ê ${points} ${points === 1 ? 'point' : 'points'}</span>`;

                let completedBy = '';
                if (isCompleted && chore.completed_by) {
                    const completer = users.find(u => u.id === chore.completed_by);
                    if (completer) {
                        completedBy = `<div class="completed-by">‚úÖ Completed by ${escapeHtml(completer.name)}</div>`;
                    }
                }

                let assignmentHtml = '';
                if (!chore.assigned_to_all && chore.assignments && chore.assignments.length > 0) {
                    assignmentHtml = '<div style="margin-top: 15px;">';
                    chore.assignments.forEach(assignment => {
                        const isCurrentUser = assignment.user_id === currentUser.id;
                        const canComplete = isAdmin || isCurrentUser;
                        
                        if (canComplete || isAdmin) {
                            const checkboxId = `assignment-${assignment.id}`;
                            const checked = assignment.completed ? 'checked' : '';
                            // Only disable if already completed and user is not admin
                            const disabled = (assignment.completed && !isAdmin) ? 'disabled' : '';
                            // Prevent unchecking unless admin
                            const onclick = assignment.completed && !isAdmin ? 'return false;' : '';
                            
                            assignmentHtml += `
                                <div class="checkbox-wrapper" style="margin-bottom: 10px;">
                                    <input type="checkbox" id="${checkboxId}" ${checked} ${disabled}
                                        onclick="${onclick}"
                                        onchange="completeAssignment(${assignment.id}, this.checked, '${checkboxId}')">
                                    <label for="${checkboxId}" style="cursor: pointer;">
                                        ${escapeHtml(assignment.user_name)}${assignment.completed ? ' ‚úÖ' : ''}
                                    </label>
                                </div>
                            `;
                        }
                    });
                    assignmentHtml += '</div>';
                }

                let actions = '';
                if (chore.assigned_to_all) {
                    // General chore - show complete checkbox
                    if (isAdmin || !isCompleted) {
                        const checkboxId = `chore-${chore.id}`;
                        const checked = isCompleted ? 'checked' : '';
                        actions = `
                            <div class="checkbox-wrapper">
                                <input type="checkbox" id="${checkboxId}" ${checked}
                                    onchange="toggleComplete(${chore.id}, this.checked)">
                                <label for="${checkboxId}" style="cursor: pointer;">Mark as Complete</label>
                            </div>
                        `;
                    }
                }

                if (isAdmin) {
                    actions += `
                        <button class="btn btn-secondary" onclick="editChore(${chore.id})" style="padding: 10px 20px;">‚úèÔ∏è Edit</button>
                        <button class="btn btn-danger" onclick="deleteChore(${chore.id})" style="padding: 10px 20px;">üóëÔ∏è Delete</button>
                    `;
                }

                return `
                    <div class="chore-card ${completedClass} ${priorityClass}">
                        <div class="chore-header">
                            <div class="chore-title">${escapeHtml(chore.title)}</div>
                            <div class="chore-badges">
                                ${pointsBadge}
                                ${recurrenceBadge}
                                ${chore.assigned_to_all ? '<span class="badge">üë• Everyone</span>' : '<span class="badge">üë§ Assigned</span>'}
                            </div>
                        </div>
                        ${chore.description ? `<div class="chore-description">${escapeHtml(chore.description)}</div>` : ''}
                        ${completedBy}
                        ${assignmentHtml}
                        <div class="chore-actions">
                            ${actions}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Toggle complete
        async function toggleComplete(choreId, completed) {
            try {
                await fetch(`/api/chores/${choreId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        completed: completed,
                        completed_by: completed ? currentUser.id : null
                    })
                });
                
                if (completed) {
                    showConfetti();
                    playSound();
                }
                
                loadChores();
                loadLeaderboard();
            } catch (error) {
                console.error('Error updating chore:', error);
                alert('Failed to update chore.');
            }
        }

        // Complete assignment
        async function completeAssignment(assignmentId, completed, checkboxId) {
            console.log('Completing assignment:', assignmentId, 'completed:', completed);
            
            // Keep the checkbox checked while processing
            const checkbox = document.getElementById(checkboxId);
            if (checkbox && completed) {
                checkbox.disabled = true;
            }
            
            try {
                const response = await fetch(`/api/chores/assignment/${assignmentId}/complete`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ completed: completed })
                });
                
                const responseData = await response.json();
                console.log('Response:', response.status, responseData);
                
                if (!response.ok) {
                    throw new Error(responseData.error || 'Failed to complete assignment');
                }
                
                if (completed) {
                    showConfetti();
                    playSound();
                }
                
                // Wait a moment before reloading to ensure the backend has processed
                await new Promise(resolve => setTimeout(resolve, 100));
                
                await loadChores();
                await loadLeaderboard();
            } catch (error) {
                console.error('Error completing assignment:', error);
                alert('Failed to complete assignment. Please try again.\nError: ' + error.message);
                // Restore checkbox state on error
                if (checkbox) {
                    checkbox.checked = !completed;
                    checkbox.disabled = false;
                }
            }
        }

        // Load leaderboard
        async function loadLeaderboard() {
            try {
                const response = await fetch('/api/leaderboard');
                const leaderboard = await response.json();
                renderLeaderboard(leaderboard);
            } catch (error) {
                console.error('Error loading leaderboard:', error);
            }
        }

        // Render leaderboard
        function renderLeaderboard(leaderboard) {
            const grid = document.getElementById('leaderboardGrid');
            
            grid.innerHTML = leaderboard.map((entry, index) => {
                const rank = index + 1;
                const rankClass = `rank-${rank}`;
                const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : '';
                const avatar = entry.avatar || 'üë§';
                const color = entry.color || '#6366f1';
                
                return `
                    <div class="leaderboard-item ${rankClass}" onclick="showUserHistory(${entry.id}, '${escapeHtml(entry.name)}')">
                        <div class="leaderboard-rank">${medal || rank}</div>
                        <div class="leaderboard-avatar" style="background: ${color};">${avatar}</div>
                        <div class="leaderboard-info">
                            <div class="leaderboard-name">${escapeHtml(entry.name)}</div>
                        </div>
                        <div class="leaderboard-points">${entry.points} <span style="font-size: 0.6em;">‚≠ê</span></div>
                    </div>
                `;
            }).join('');
        }

        // Show user history
        async function showUserHistory(userId, userName) {
            try {
                const response = await fetch(`/api/users/${userId}/history`);
                const history = await response.json();
                
                const modal = document.getElementById('historyModal');
                document.getElementById('historyModalTitle').textContent = `üéâ ${userName}'s Completed Chores`;
                
                const list = document.getElementById('historyList');
                if (history.length === 0) {
                    list.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No completed chores this week yet!</p>';
                } else {
                    list.innerHTML = history.map(item => `
                        <div style="padding: 15px; background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); border-radius: 15px; margin-bottom: 10px;">
                            ‚úÖ ${escapeHtml(item.title)}
                        </div>
                    `).join('');
                }
                
                modal.style.display = 'block';
            } catch (error) {
                console.error('Error loading history:', error);
            }
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').style.display = 'none';
        }

        // Profile customization
        function openProfileModal() {
            const modal = document.getElementById('profileModal');
            
            // Render avatars
            const avatarPicker = document.getElementById('avatarPicker');
            avatarPicker.innerHTML = avatars.map(avatar => {
                const selected = avatar === currentUser.avatar ? 'selected' : '';
                return `<div class="avatar-option ${selected}" onclick="selectAvatar('${avatar}')">${avatar}</div>`;
            }).join('');
            
            // Render colors
            const colorPicker = document.getElementById('colorPicker');
            colorPicker.innerHTML = colors.map(color => {
                const selected = color === currentUser.color ? 'selected' : '';
                return `<div class="color-option ${selected}" style="background: ${color};" onclick="selectColor('${color}')"></div>`;
            }).join('');
            
            modal.style.display = 'block';
        }

        function closeProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
        }

        function selectAvatar(avatar) {
            currentUser.avatar = avatar;
            document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        function selectColor(color) {
            currentUser.color = color;
            document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
            event.target.classList.add('selected');
        }

        async function saveProfile() {
            try {
                const response = await fetch(`/api/users/${currentUser.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        avatar: currentUser.avatar,
                        color: currentUser.color
                    })
                });
                
                const updatedUser = await response.json();
                
                // Update UI
                document.getElementById('currentPlayerAvatar').textContent = updatedUser.avatar;
                document.getElementById('currentPlayerDisplay').style.background = updatedUser.color;
                
                // Update users array
                const userIndex = users.findIndex(u => u.id === currentUser.id);
                if (userIndex !== -1) {
                    users[userIndex] = updatedUser;
                }
                
                closeProfileModal();
                loadLeaderboard();
                showConfetti();
            } catch (error) {
                console.error('Error saving profile:', error);
                alert('Failed to save profile.');
            }
        }

        // Chore modal
        function openAddChoreModal() {
            editingChoreId = null;
            document.getElementById('choreModalTitle').textContent = '‚ûï Add New Chore';
            document.getElementById('choreForm').reset();
            document.getElementById('assignToAll').checked = true;
            toggleAssignments();
            document.getElementById('choreModal').style.display = 'block';
        }

        function editChore(choreId) {
            const chore = chores.find(c => c.id === choreId);
            if (!chore) return;
            
            editingChoreId = choreId;
            document.getElementById('choreModalTitle').textContent = '‚úèÔ∏è Edit Chore';
            document.getElementById('title').value = chore.title;
            document.getElementById('description').value = chore.description || '';
            document.getElementById('priority').value = chore.priority;
            document.getElementById('recurrenceType').value = chore.recurrence_type;
            document.getElementById('assignToAll').checked = chore.assigned_to_all;
            
            toggleAssignments();
            
            if (!chore.assigned_to_all && chore.assignments) {
                const assignedUserIds = chore.assignments.map(a => a.user_id);
                document.querySelectorAll('.assignment-checkbox').forEach(checkbox => {
                    checkbox.checked = assignedUserIds.includes(parseInt(checkbox.value));
                });
            }
            
            document.getElementById('choreModal').style.display = 'block';
        }

        function closeChoreModal() {
            document.getElementById('choreModal').style.display = 'none';
            editingChoreId = null;
        }

        function toggleAssignments() {
            const assignToAll = document.getElementById('assignToAll').checked;
            const assignmentsDiv = document.getElementById('userAssignments');
            assignmentsDiv.style.display = assignToAll ? 'none' : 'block';
            
            if (!assignToAll && !document.getElementById('assignmentCheckboxes').innerHTML) {
                // Populate checkboxes for ALL users (including admins)
                document.getElementById('assignmentCheckboxes').innerHTML = users.map(u => `
                    <label style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer;">
                        <input type="checkbox" value="${u.id}" class="assignment-checkbox" style="width: auto; margin-right: 10px;">
                        <span>${escapeHtml(u.name)}${u.role === 'admin' ? ' (Admin)' : ''}</span>
                    </label>
                `).join('');
            }
        }

        // Handle chore form submission
        document.getElementById('choreForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                title: document.getElementById('title').value,
                description: document.getElementById('description').value,
                priority: document.getElementById('priority').value,
                recurrence_type: document.getElementById('recurrenceType').value,
                assigned_to_all: document.getElementById('assignToAll').checked
            };

            if (!formData.assigned_to_all) {
                const assignedUsers = Array.from(document.querySelectorAll('.assignment-checkbox:checked')).map(cb => parseInt(cb.value));
                if (assignedUsers.length === 0) {
                    alert('Please select at least one person to assign this chore to.');
                    return;
                }
                formData.assigned_users = assignedUsers;
            }

            try {
                const url = editingChoreId ? `/api/chores/${editingChoreId}` : '/api/chores';
                const method = editingChoreId ? 'PUT' : 'POST';
                
                await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                closeChoreModal();
                loadChores();
                showConfetti();
            } catch (error) {
                console.error('Error saving chore:', error);
                alert('Failed to save chore.');
            }
        });

        // Delete chore
        async function deleteChore(choreId) {
            if (!confirm('Are you sure you want to delete this chore?')) return;
            
            try {
                await fetch(`/api/chores/${choreId}`, { method: 'DELETE' });
                loadChores();
                loadLeaderboard();
            } catch (error) {
                console.error('Error deleting chore:', error);
                alert('Failed to delete chore.');
            }
        }

        // Confetti effect
        function showConfetti() {
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff', '#ffa500', '#ff1493'];
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + 'vw';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = Math.random() * 0.5 + 's';
                    document.body.appendChild(confetti);
                    
                    setTimeout(() => confetti.remove(), 3000);
                }, i * 30);
            }
        }

        // Play sound (simple beep using Web Audio API)
        function playSound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }

        // Utility
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Close modals on outside click
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>
